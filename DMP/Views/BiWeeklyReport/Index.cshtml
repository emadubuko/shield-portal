@model DMP.ViewModel.BWR.ReportViewModel


@section AddToHead{
    @Styles.Render("~/bundles/CreateDMPCss")
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.11.4/themes/ui-lightness/jquery-ui.css">

    <style>
        .form-control {
            border-color: #29b6f6;
        }

        form {
            color: #000;
        }
    </style>
}

<a class="btn btn-info" id="uploadRpt">
    <i class="icon-upload"></i> &nbsp;<span>Upload New Report</span>
</a>
<div id="page-wrapper" class="main-content">     
    

    <div class="panel panel-info">
        <div class="panel-heading clearfix">
            Bi-Weekly Reports
        </div>
        <!-- /.panel-heading -->
        <div class="panel-body">
            <div class="table-responsive" style="overflow-x: initial;">
                <table style="width:100%" class="table table-striped table-bordered table-hover" id="dataTables">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date Uploaded</th>
                            <th>Report Name</th>
                            <th>Implementing Partner</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (BWReport.DAL.Entities.ReportUploads item in Model.Reports)
                        {
                            <tr>
                                <td>@item.Id</td>
                                <td>@item.DateUploaded</td>
                                <td>@item.ReportName.Replace(".xlsx", "")</td>
                                <td>@item.ImplementingPartner</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" data-keyboard="false" data-backdrop="static" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" style="width: 500px;border-color: #29b6f6;" role="document">
        <div class="modal-content">
            <div class="modal-header" style="color: #FFF;background-color: #29b6f6;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" style="text-align: center;">Upload Report</h4>
            </div>
            <div style="padding-top: 15px; padding-left: 7px;">
                <form class="form-horizontal" role="form">
                    <label id="error" class="text-danger" style="display:none"></label>

                    <div class="form-group">
                        <label class="col-sm-4 control-label">Report Date From:</label>
                        <div class="col-sm-7">
                            <div id="reportDateFrom" class="input-group date">
                                <input type="text" required id="reportDateFrom" data-format="D, dd MM yyyy" class="form-control">
                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Report Date To:</label>
                        <div class="col-sm-7">
                            <div id="reportDateTo" class="input-group date">
                                <input type="text" required id="reportDateTo" data-format="D, dd MM yyyy" class="form-control">
                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-4 control-label"> Upload:</label>
                        <div class="col-md-7">
                            <input type="file" class="form-control" id="fileUpload" placeholder="Upload CSV file" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="col-sm-3">     </div>
                <div class="col-sm-7">
                    <button type="button" class="btn btn-default" data-dismiss="modal"> Cancel</button>
               
                    <button id="upload" type="button" class="btn btn-primary"><i class="fa fa-upload"></i> &nbsp; Upload</button>
                    <img id="loadImg" style="display:none" class="center" src="~/images/spinner.gif" width="36">
                </div>
            </div>
        </div>
    </div>
</div>



@section Scripts
{
@Scripts.Render("~/bundles/CreateDMPJs")
    @Scripts.Render("~/bundles/dataTables")

    <script>

        $(document).ready(function () {
            $("#uploadRpt").click(function () {
                $('#uploadModal').modal('show');
            });

            $('#dataTables').DataTable({
                responsive: true
            });
            

            $("#upload").click(function (e, n) {

                $('#upload submit').disabled = true;
                $("#loadImg").show();

                var data = new FormData();

                try {
                    var file = $('form input[type=file]')[0].files[0];
                    data.append('file', file);
                    var dateTo = $("form #reportDateTo")[1].value;
                    var dateFrom = $("form #reportDateFrom")[1].value;
                }
                catch (e) {
                    $('#submit').disabled = false;
                    $("#loadImg").hide();
                    $("#error").append("system error occurred. Please provide valid inputs")
                    $("#error").show();
                    return false;
                }
                

                $.ajax({
                    type: "POST",
                    url: '/BiWeeklyReport/Upload?reportingPeriodFrom=' + dateFrom + '&reportingPeriodTo=' + dateTo,
                    contentType: false,
                    processData: false,
                    data: data,
                    cache: false,
                }).done(function (result) {
                    $('#submit').disabled = false;
                    $("#loadImg").hide();
                    console.log(result);
                    $("#error").hide();
                    alert("Upload succesful");
                }).error(function (xhr, status, err) {
                    console.log(err);
                    $('#submit').disabled = false;
                    $("#loadImg").hide();
                    $("#error").append(err);
                    $("#error").show();
                });
                return false;

            });
        });
    </script>



}
