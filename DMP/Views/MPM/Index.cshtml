@model  MPM.DAL.UploadViewModel
@{
    Layout = "~/Views/Shared/_mpmlayout.cshtml";
}


@section AddToHead{
    <link href="~/Content/jquery-ui.css" rel="stylesheet" />
    <script src="~/Scripts/Ultilities.js?v=@DateTime.Now.Ticks.ToString()"></script>
    <style>

        .btn-sm, .btn-group-sm > .btn {
            padding: 0px;
        }

        .btn-danger {
            background-color: red;
            border-color: red;
            cursor: default;
        }
    </style>

    <script type="text/javascript">

    </script>
}


<div class="col-sm-9">
    <div style="padding-left: 30%; font-weight: bolder;">
        Upload Tracker
    </div>
    <div class="table-responsive" style="overflow-x: initial;">
        <table style="width:100%" class="table table-striped table-bordered">
            <thead>
                <tr style="color: #FFF;background-color: darkturquoise;border-color: darkturquoise;">
                    <th>IP</th>
                    <th>State</th>
                    <th><div><span>Jan @DateTime.Now.Year</span></div></th>
                    <th><div><span>Feb @DateTime.Now.Year</span></div></th>
                    <th><div><span>Mar @DateTime.Now.Year</span></div></th>
                    <th><div><span>Apr @DateTime.Now.Year</span></div></th>
                    <th><div><span>May @DateTime.Now.Year</span></div></th>
                    <th><div><span>Jun @DateTime.Now.Year</span></div></th>
                    <th><div><span>Jul @DateTime.Now.Year</span></div></th>
                    <th><div><span>Aug @DateTime.Now.Year</span></div></th>
                    <th><div><span>Sep @DateTime.Now.Year</span></div></th>
                    <th><div><span>Oct @DateTime.Now.Year</span></div></th>
                    <th><div><span>Nov @DateTime.Now.Year</span></div></th>
                    <th><div><span>Dec @DateTime.Now.Year</span></div></th>
                </tr>
            </thead>
            <tbody>

                @foreach (var item in Model.IPReports)
                {
                    <tr>
                        <td>@item.Key.Split('|')[1]</td>
                        <td>@item.Key.Split('|')[0]</td>
                        @foreach (var date in item.Value)
                        {
                            if (date)
                            {
                                <td id="@date"><a class="btn btn-sm btn-success download" id="@item.Key"><i class="icon-check"></i></a></td>
                            }
                            else
                            {
                                <td><a class="btn btn-sm btn-danger"><i class="icon-cancel"></i></a></td>
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


<div class="row">

    <div class="col-sm-12">
        <div style="text-transform:capitalize;margin-top: 20px;">

            <div class="col-sm-2">
                <a class="btn btn-success" id="download_to_excel" style="font-size: 12px;margin-bottom: -50px;">Download to Excel</a>
            </div>

            <div class="col-sm-offset-1 col-sm-4">
                <h4 style="margin-bottom: -50px;font-weight:bold"> Detailed Completion Report for <span id="reportPeriod"></span></h4>
            </div>

            <div style="float: right;" class="col-sm-3">
                <span class="col-sm-7">Change reporting period </span>
                <select id="rpt_type" class="form-control col-sm-6">
                    @foreach (var p in ViewBag.ReportedPeriods)
                    {
                        if (p == @ViewBag.reportPeriod)
                        {
                            <option value="@p" selected>@p</option>
                        }
                        else
                        {
                            <option value="@p">@p</option>
                        }
                    }
                </select>
            </div>
        </div>
    </div>

    <div class="col-sm-12">
        <div class="table-responsive" style="font-size: 11px; padding: 15px;">
            <table class="table table-striped table-bordered" id="output" style="width:100%">
                <thead>
                    <tr style="color: #FFF;background-color: darkturquoise;border-color: darkturquoise;">
                        <th>IP</th>
                        <th>State Id</th>
                        <th>LGA</th>
                        <th>Facility</th>
                        <th>PMTCT</th>
                        <th>PMTCT EID</th>
                        <th>ART</th>
                        <th>HTS</th>
                        <th>HTS PITC</th>
                        <th>Linkage To Linkage</th>
                        <th>PMTCT Viral Load</th>
                        <th>TB HIV Treatment</th>
                        <th>TB Presumptive</th>
                        <th>TB Presumptive Diagnosed</th>
                        <th>TPT Completed</th>
                        <th>TPT Eligible</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts
{
    <script>
        $(document).ready(function () {
              
            $(".download").click(function (e) {

                var ans = confirm("Download the uploaded file ?");
                if (ans) {
                    $("#loadImg2").show();
                    $.ajax({
                        url: '/MPM/DownloadPreviousReport?IPState=' + e.currentTarget.id,
                        type: 'POST',
                        cache: false,
                        contentType: false,
                        processData: false
                    }).done(function (response) {
                        if (response) {
                            window.location = '/Report/' + response;
                        }
                        else {
                            alert("file not found");
                        }
                        $("#loadImg2").hide();
                    }).error(function (xhr, status, err) {
                        console.log(xhr.responseText);
                        $("#loadImg2").hide();
                    });
                }
            })

            $("#download_to_excel").on('click', function (event) {
                exportTableToCSV.apply(this, [$("#output"), 'report.csv', '-', 0, 0]);
            });

            let reportPeriod = '@ViewBag.reportPeriod';
            $("#reportPeriod").html('@ViewBag.reportPeriod');
            $.ajax({
                url: '/MPM/ReportDetails?reportPeriod=' + reportPeriod,
                type: 'POST',
                cache: false,
                contentType: false,
                processData: false
            }).done(function (response) {
                buildTable(response);
                $("#loadImg2").hide();
            }).error(function (xhr, status, err) {
                console.log(xhr.responseText);
                $("#loadImg2").hide();
            });

            $('#rpt_type').on('change', function () {

                $("#reportPeriod").html(this.value);

                $.ajax({
                    url: '/MPM/ReportDetails?reportPeriod=' + this.value,
                    type: 'POST',
                    cache: false,
                    contentType: false,
                    processData: false
                }).done(function (response) {
                    buildTable(response); 
                    $("#loadImg2").hide();
                }).error(function (xhr, status, err) {
                    console.log(xhr.responseText);
                    $("#loadImg2").hide();
                }); 
            });


            function buildTable(dataList) {
                $("#output tbody").empty();
                $.each(dataList, function (i, d) {
                    var html = "<tr> ";
                    Object.keys(d).forEach(e => html += "<td>" + d[e] + "</td>");
                    html += "</tr>";
                    $("#output tbody").append(html);
                });
            }

        });
    </script>
}
