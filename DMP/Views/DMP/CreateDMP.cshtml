@model  ShieldPortal.ViewModel.CreateDMPViewModel
@{
    ViewBag.Title = "Create New ShieldPortal";
}
@section AddToHead{
    @Styles.Render("~/bundles/CreateDMPCss")
    @Styles.Render("~/bundles/mysiteCss")

    <script src="~/Scripts/Ultilities.js"></script>
<script type="text/javascript">

       var selectedOrg;
                   @{
                       System.Web.Script.Serialization.JavaScriptSerializer serializer = new System.Web.Script.Serialization.JavaScriptSerializer();
                       serializer.MaxJsonLength = Int32.MaxValue;
                   }
       var orgs = @Html.Raw(serializer.Serialize(Model.OrganizationList));

       function  BindOrganizationImage(e){
           console.log(e)
           if(e !== undefined){
               for(var i=0; i <orgs.length; i++){
                   if(parseInt(e.value) === orgs[i].Id){
                       selectedOrg = orgs[i];
                       BindImageToControl($('#imageURL'),selectedOrg.Logo );
                       $("#logoDiv").show()
                   }
               }
           }
       }
</script>
}

<div class="main-content">
    
    <div class="row">
        <div class="col-lg-12">
            <form id="dmpForm" class="validate">
                <div class="panel panel-warning">
                    <div class="panel-heading clearfix">
                        <h4 class="panel-title">Begin a New  ShieldPortal</h4>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">

                            <div id="logoDiv" style="display:none" class="form-group">
                                <label class="col-sm-2 control-label">Logo</label>
                                <div class="col-sm-8">
                                    <img id="imageURL" height="100">
                                </div>
                            </div>
                            
                            @foreach (var field in Model.FieldCollection)
                            {
                                <div class="form-group">
                                    <label class="col-sm-2 control-label" for="@field.Key.Replace(" ","")">@field.Key</label>
                                    <div class="col-sm-8">
                                        @if ((string)field.Value == "String")
                                        {
                                            <input type="text" placeholder="@Model.ToolTip[field.Key]" id="@field.Key.Replace(" ","")" required title="@field.Key is required" class="form-control">
                                        }
                                        else if ((string)field.Value == "Organizations")
                                        {
                                            <select  onchange="BindOrganizationImage(this)"  id="OrganizationId" class="form-control" required>
                                                <option value="" disabled selected>select organization</option>
                                                @foreach (var item in Model.OrganizationList)
                                                {
                                                    <option value="@item.Id">@item.Name (@item.ShortName)</option>
                                                }
                                            </select>
                                        }
                                        else if ((string)field.Value == "DateTime")
                                        {
                                            <div id="@field.Key.Replace(" ","")" class="input-group date">
                                                <input type="text" required id="@field.Key.Replace(" ","")" placeholder="@field.Key" title="select a end date" data-format="D, dd MM yyyy" class="form-control">
                                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <a href='@Url.Action("index","Home")' class="btn btn-default">
                                        <i class="fa fa-close"></i> Cancel
                                    </a>
                                    &nbsp;&nbsp;
                                    <button type="submit" id="dmpSubmit" class="btn btn-warning">Save</button>
                                    <img id="loadImg" style="display:none" class="center" src="~/images/spinner.gif" width="36">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </form>

        </div>
    </div>
</div>




@section Scripts
{
    @Scripts.Render("~/bundles/CreateDMPJs")
    <script>
        $(document).ready(function () {
                       
            $("input").attr("autocomplete", "off");

            $("#dmpSubmit").click(function (e, n) {

                var form = $(e.currentTarget.form);
                var validator = form.validate();
                if (form.valid()) {
                    
                    var formdata = $('#dmpForm')[0].elements;
                    var viewModel = {};

                    $("#loadImg").show();
                    $('#dmpSubmit').disabled = true;

                    $.each(formdata, function (name, formElements) {
                        viewModel[formElements.id] = formElements.value;
                    });

                    var redirectUrl = '@Url.Action("WizardPages", "DMPDocument")';
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("SaveDMP", "ShieldPortal")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(viewModel),
                        cache: false,
                    }).done(function (dmpId) {
                        console.log(dmpId);
                        window.location.replace(redirectUrl + '?dmpId=' + dmpId);
                    }).error(function (xhr, status, err) {
                        alert(err);
                        console.log(err);
                        $("#loadImg").hide();
                        $('#dmpSubmit').disabled = false;
                    });
                    return false;
               }
            });

        });
    </script>
}